{% extends "base.html" %}
{% block lab %}РГЗ - Поиск{% endblock %}

{% block main %}
    <style>
        /* Контейнер фильтров */
        .filters {
            background: #f8f9fa; /* Светло-серый фон панели */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            border: 1px solid #dee2e6;
            align-items: center;
        }

        /* Поля ввода */
        .filters input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            min-width: 150px;
            color: black; /* Черный текст при вводе */
        }

        /* Кнопка поиска */
        .filters button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .filters button:hover {
            background-color: #0056b3;
        }

        /* Карточка пользователя */
        .user-card {
            background-color: white !important; /* Обязательно белый фон */
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            align-items: start;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Тень */
        }

        /* Фото пользователя */
        .user-card img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            background: #eee;
            border: 1px solid #ccc;
        }

        /* Информационный блок */
        .user-info {
            flex: 1;
        }

        /* !!!! ГЛАВНОЕ ИСПРАВЛЕНИЕ !!!! */
        /* Принудительно делаем текст черным */
        .user-info h3 { 
            margin: 0 0 10px 0; 
            color: #000 !important; /* Черный заголовок */
            font-size: 1.4em;
        }
        
        .user-info p { 
            margin: 5px 0; 
            color: #333 !important; /* Темно-серый текст */
            font-size: 1em;
            line-height: 1.4;
        }

        /* Пагинация */
        .pagination { 
            text-align: center; 
            margin-top: 30px; 
            margin-bottom: 50px;
        }
        .pagination button {
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: black;
        }
        .pagination span {
            color: black; /* Цвет номера страницы */
            font-weight: bold;
            margin: 0 10px;
        }
        
        .hidden { display: none; }
        
        /* Сообщение, если никого не нашли */
        .no-results {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-top: 20px;
        }
    </style>

    <h1>Поиск пары</h1>

    <div class="filters">
        <label for="search-name" style="color: black;">Имя:</label>
        <input type="text" id="search-name" placeholder="Введите имя">
        
        <label for="search-age" style="color: black;">Возраст:</label>
        <input type="number" id="search-age" placeholder="Возраст">
        
        <button onclick="startSearch()">Найти</button>
    </div>

    <div id="results-area">
        <p style="color: gray;">Введите параметры и нажмите "Найти", чтобы увидеть список.</p>
    </div>

    <div class="pagination">
        <button id="prev-btn" onclick="changePage(-1)" class="hidden">Назад</button>
        <span id="page-indicator" class="hidden">Страница 1</span>
        <button id="next-btn" onclick="changePage(1)" class="hidden">Вперед</button>
    </div>

    <script>
        let currentPage = 1;

        function startSearch() {
            currentPage = 1;
            loadUsers();
        }

        function changePage(delta) {
            currentPage += delta;
            if (currentPage < 1) currentPage = 1;
            loadUsers();
        }

        async function loadUsers() {
            const name = document.getElementById('search-name').value;
            const age = document.getElementById('search-age').value;
            const resultsArea = document.getElementById('results-area');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const pageInd = document.getElementById('page-indicator');

            // Формируем JSON-RPC запрос
            const payload = {
                "jsonrpc": "2.0",
                "method": "search",
                "params": {
                    "page": currentPage,
                    "name": name,
                    "age": age
                },
                "id": 1
            };

            try {
                resultsArea.innerHTML = '<p style="color: black;">Загрузка...</p>';
                
                const response = await fetch('/rgz/api', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (response.status === 401) {
                    alert("Пожалуйста, авторизуйтесь снова.");
                    window.location.href = "/rgz/login";
                    return;
                }

                const data = await response.json();
                resultsArea.innerHTML = ''; 

                if (data.error) {
                    resultsArea.innerHTML = `<p style="color:red">Ошибка: ${data.error.message || 'Неизвестная ошибка'}</p>`;
                    return;
                }

                const users = data.result;

                if (!users || users.length === 0) {
                    resultsArea.innerHTML = '<p class="no-results">Никого не найдено. <br>Попробуйте изменить параметры или убедитесь, что в вашем профиле указан пол.</p>';
                    nextBtn.classList.add('hidden');
                } else {
                    // Рендерим карточки
                    users.forEach(user => {
                        // Если фото нет, ставим заглушку
                        const photoSrc = user.photo ? `/static/rgz/${user.photo}` : 'https://via.placeholder.com/150?text=Нет+фото';
                        
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        
                        // Обработка отсутствия текста "О себе"
                        const aboutText = user.about ? user.about : 'Пользователь ничего о себе не написал.';

                        card.innerHTML = `
                            <img src="${photoSrc}" alt="${user.name}">
                            <div class="user-info">
                                <h3>${user.name}, ${user.age} лет</h3>
                                <p><strong>О себе:</strong><br>${aboutText}</p>
                            </div>
                        `;
                        resultsArea.appendChild(card);
                    });

                    // Управление кнопкой "Next"
                    // Если пришло 3 человека (лимит), показываем кнопку дальше
                    if (users.length === 3) {
                        nextBtn.classList.remove('hidden');
                    } else {
                        nextBtn.classList.add('hidden');
                    }
                }

                // Управление пагинацией
                pageInd.innerText = 'Страница ' + currentPage;
                pageInd.classList.remove('hidden');

                if (currentPage > 1) {
                    prevBtn.classList.remove('hidden');
                } else {
                    prevBtn.classList.add('hidden');
                }

            } catch (e) {
                console.error(e);
                resultsArea.innerHTML = '<p style="color:red">Ошибка соединения с сервером.</p>';
            }
        }
    </script>
{% endblock %}